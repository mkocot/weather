<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="uPlot.min.css">
  <meta http-equiv="refresh" content="300" />
</head>

<body>

  <script src="uPlot.iife.js"></script>

  <object type="application/json" id="data" data="data.json" hidden></object>

  <script type="text/javascript">
    //<embed id="hum-1" src="graph_hum.svg" type="image/svg+xml"></embed>
    //<br />
    //<object id="pres-1" data="graph_pres.svg" type="image/svg+xml"></object>
    //<br />
    //<object id="temp-1" data="graph_temp.svg" type="image/svg+xml"></object>
    //<br />
    //<object id="volt-1" data="graph_volt.svg" type="image/svg+xml"></object>
    //<br />
    //<div style="width:40%;">
    //<canvas id="plot-1"></canvas>
    //</div>

    var data = {};
    var sensorid = "e09806259a";
    var sensorid2 = "24a1603048";
    function normalizePres(data) {
      data.forEach(function (v, i) {
        if (v > 0) {
          this[i] = Math.round(v);
        }
      }, data);
    }
    document.getElementById("data").addEventListener("load", function () {
      data = JSON.parse(this.contentDocument.body.textContent);
      console.log("Data fetched");
      var augmented = [];
      //normalizePres(data[sensorid]["pres"]);
      //normalizePres(data[sensorid2]["pres"]);
      let opts = {
        title: "Temp [*C]",
        id: "chart1",
        class: "my-chart",
        width: 800,
        height: 200,
        series: [
          {
            value: "{YYYY}/{MM}/{DD} {HH}:{mm}:00"
          },
          {
            // initial toggled state (optional)
            show: true,

            spanGaps: false,

            // in-legend display
            label: "Sensor 1",
            value: (self, rawValue) => !rawValue && "??" || rawValue.toFixed(1) + "*C",

            // series style
            stroke: "red",
            width: 1,
            fill: "rgba(255, 0, 0, 0.3)",
          },
          {
            label: "Sensor 2",
            show: true,
            spanGaps: false,
            value: (self, rawValue) => !rawValue && "??" || rawValue.toFixed(1) + "*C",
          }
        ],
      };
      var timepoints = data["time"];
      var uplot = new uPlot(opts, [timepoints, data[sensorid]["temp"], data[sensorid2]["temp"]], document.body);

      opts.title = "Humidity [%]";
      opts.series[1].fill = "rgba(0, 0, 255, 0.3)";
      opts.series[1].value = (self, rawValue) => !rawValue && "??" || rawValue.toFixed(0) + "%";
      opts.series[1].stroke = "blue";
      opts.series[2].value = opts.series[1].value;
      var uplot = new uPlot(opts, [timepoints, data[sensorid]["hum"], data[sensorid2]["hum"]], document.body);

      opts.title = "Pressure [hPa]";
      opts.series[1].fill = "rgba(0, 255, 255, 0.3)";
      opts.series[1].value = (self, rawValue) => !rawValue && "??" || rawValue.toFixed(0) + "hPa";
      opts.series[1].stroke = "purple";
      opts.series[2].value = opts.series[1].value;
      var uplot = new uPlot(opts, [timepoints, data[sensorid]["pres"], data[sensorid2]["pres"]], document.body);

      opts.title = "Bat [V]";
      opts.series[1].fill = "rgba(255, 0, 0, 0.3)";
      opts.series[1].value = (self, rawValue) => !rawValue && "??" || rawValue.toFixed(3) + "V";
      opts.series[1].stroke = "red";
      opts.series[2].value = opts.series[1].value;
      var uplot = new uPlot(opts, [timepoints, data[sensorid]["volt"], data[sensorid2]["volt"]], document.body);
    });
    // <object id="asd" data="data.json" type="application/json" class="hidden" ></object>
    function regDynamic(name, dataset) {
      var svg = document.getElementById(name);
      svg.addEventListener("load", function () {
        var doc = this.getSVGDocument();
        var surface2 = doc.querySelector("#surface2");
        var wholegraph = surface2.querySelector("rect");
        var plotonly = surface2.querySelector("path");
        var scaleX = wholegraph.getBBox().width / svg.clientWidth;

        doc.addEventListener("click", function (e) {
          var Vals = dataset();
          var NminusOne = Vals.length - 1;
          var X = e.clientX * scaleX - plotonly.getBBox().x;
          X /= plotonly.getBBox().width;
          X = Math.min(Math.max(X, 0), 1);

          // Now X is normalized <0; 1> in plot space
          // As we have array with N elements just pick closes one
          var fuzzyIndex = NminusOne * X;
          var index = Math.floor(fuzzyIndex);
          var lerpFactor = fuzzyIndex - index;
          var nextIndex = index;
          if (index < NminusOne) {
            nextIndex += 1;
          }
          var a = Vals[index];
          var b = Vals[nextIndex];
          var c = (1 - lerpFactor) * a + lerpFactor * b;
          // Use floor(N*X) ceil(N*X) and lerp between
          console.log("findex=", fuzzyIndex);
          console.log("index=", index, "a=", a);
          console.log("nextIndex=", nextIndex, "b=", b);
          console.log("c=", c);
        });
      })
    }
// Init
// regDynamic("hum-1", function() { return data[sensorid]["hum"];});

//var ctx = document.getElementById("pres-1").getContext("2d");
//console.log(ctx);

  </script>

</body>

</html>
